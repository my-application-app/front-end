name: Frontend CD Pipeline

on:
  workflow_run:
    workflows: ["Frontend CI Pipeline"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check kubectl connection
      run: |
        kubectl cluster-info --request-timeout=10s
        echo "‚úÖ Kubernetes connection verified"
    
    - name: Deploy Frontend to Kubernetes
      run: |
        echo "üì¶ Deploying Frontend to Kubernetes..."
        
        # Deploy frontend k8s files
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/hpa.yaml
        kubectl apply -f k8s/network-policies.yaml
        kubectl apply -f k8s/nodeport.yaml
        
        echo "‚úÖ All Frontend Kubernetes manifests applied"
    
    - name: Wait for deployment
      run: |
        echo "‚è≥ Waiting for frontend deployment to be ready..."
        kubectl rollout status deployment/frontend -n bedrock-chat-v2 --timeout=300s || echo "Deployment taking longer than expected, checking status..."
    
    - name: Verify deployment
      run: |
        echo "üîç Verifying frontend deployment..."
        
        # Check pods
        echo "Frontend Pods:"
        kubectl get pods -n bedrock-chat-v2 -l app=frontend
        
        # Check services
        echo "Frontend Services:"
        kubectl get svc -n bedrock-chat-v2 frontend
        kubectl get svc -n bedrock-chat-v2 frontend-nodeport
        
        # Check HPA
        echo "Frontend HPA:"
        kubectl get hpa -n bedrock-chat-v2 frontend-hpa || echo "HPA not ready yet"
        
        echo "‚úÖ Frontend deployment verification completed"
    
    - name: Deployment Summary
      run: |
        echo "üéâ Frontend CD Pipeline completed successfully!"
        echo "üìã Deployment Summary:"
        echo "   Namespace: bedrock-chat-v2"
        echo "   Image: samitsinghhh/frontend:v3"
        echo "   Commit: ${{ github.sha }}"
        
        # Get final status
        echo "Final Frontend Status:"
        kubectl get all -n bedrock-chat-v2 -l app=frontend
